#!/bin/bash

set -e

echo "=== –û–°–í–û–ë–û–ñ–î–ï–ù–ò–ï –ü–û–†–¢–ê 80 ==="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç 80
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç 80..."
sudo netstat -tlnp | grep :80 || echo "–ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 80"
sudo lsof -i :80 || echo "–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 80"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ nginx –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã nginx..."
ps aux | grep nginx || echo "Nginx –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π nginx –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π nginx..."
sudo systemctl stop nginx 2>/dev/null || echo "–°–∏—Å—Ç–µ–º–Ω—ã–π nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω"
sudo systemctl disable nginx 2>/dev/null || echo "–°–∏—Å—Ç–µ–º–Ω—ã–π nginx —É–∂–µ –æ—Ç–∫–ª—é—á–µ–Ω"

# –£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 80
echo "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 80..."
sudo fuser -k 80/tcp 2>/dev/null || echo "–ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç—É 80"

# –ñ–¥—ë–º –Ω–µ–º–Ω–æ–≥–æ
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ—Ä—Ç –æ—Å–≤–æ–±–æ–¥–∏–ª—Å—è
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞ 80..."
if sudo netstat -tlnp | grep :80; then
    echo "‚ùå –ü–æ—Ä—Ç 80 –≤—Å—ë –µ—â—ë –∑–∞–Ω—è—Ç!"
    sudo netstat -tlnp | grep :80
    exit 1
else
    echo "‚úÖ –ü–æ—Ä—Ç 80 –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω!"
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd $HOME/foodgram

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
sudo docker compose -f infra/docker-compose.yml up -d nginx

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
sudo docker compose -f infra/docker-compose.yml ps

echo "=== –ì–û–¢–û–í–û ==="
echo "üåê –°–∞–π—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: http://89.169.174.76" 