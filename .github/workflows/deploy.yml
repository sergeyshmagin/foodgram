name: Deploy Foodgram to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROD_HOST: 89.169.174.76
  DOMAIN: foodgram.freedynamicdns.net

jobs:
  tests:
    name: Run tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements/development.txt
        
    - name: Run tests
      run: |
        cd backend
        python -m pytest --tb=short -v
        
    - name: Check code style
      run: |
        cd backend
        flake8 .

  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest
    needs: tests
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        debug: true
        script: |
          set -e
          
          echo "=== ÐÐÐ§ÐÐ›Ðž Ð”Ð•ÐŸÐ›ÐžÐ¯ ==="
          echo "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $(whoami)"
          echo "Ð”Ð¾Ð¼Ð°ÑˆÐ½ÑÑ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $HOME"
          echo "Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $(pwd)"
          
          echo "ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ..."
          mkdir -p $HOME/foodgram
          cd $HOME/foodgram
          
          echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð°..."
          if [ -d ".git" ]; then
            echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
            git fetch origin
            git reset --hard origin/main
          else
            echo "ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
            # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿
            git clone https://github.com/${{ github.repository }}.git . || {
              echo "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· HTTPS, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±..."
              # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ½Ð¾Ð²Ð°
              rm -rf .git
              # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ wget Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð°Ñ€Ñ…Ð¸Ð²Ð°
              wget -O repo.zip https://github.com/${{ github.repository }}/archive/refs/heads/main.zip
              unzip -o repo.zip
              mv *-main/* .
              mv *-main/.* . 2>/dev/null || true
              rm -rf *-main repo.zip
              echo "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· Ð°Ñ€Ñ…Ð¸Ð²"
            }
          fi
          
          echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
          mkdir -p infra
          cat > infra/.env << EOF
          # Django settings
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DJANGO_SETTINGS_MODULE=foodgram.settings.production
          ALLOWED_HOSTS=${{ env.DOMAIN }},${{ env.PROD_HOST }},localhost,127.0.0.1
          
          # Database
          POSTGRES_DB=foodgram
          POSTGRES_USER=foodgram_user
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          
          # Redis
          REDIS_HOST=redis
          REDIS_PORT=6379
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # MinIO
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          MINIO_BUCKET_NAME=foodgram
          MINIO_USE_HTTPS=False
          MINIO_HOST=minio
          
          # Email
          EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
          DEFAULT_FROM_EMAIL=noreply@${{ env.DOMAIN }}
          
          # Domain
          DOMAIN_NAME=${{ env.DOMAIN }}
          EOF
          
          echo "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Docker..."
          sudo usermod -aG docker $USER || echo "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ docker"
          sudo systemctl restart docker || echo "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Docker"
          
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker..."
          docker --version || echo "Docker Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
          docker compose version || docker-compose --version || echo "Docker Compose Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
          
          echo "ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
          sudo docker compose -f infra/docker-compose.yml down --remove-orphans || echo "ÐÐµÑ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²"
          
          echo "ðŸ”§ ÐŸÐ Ð•Ð”Ð’ÐÐ Ð˜Ð¢Ð•Ð›Ð¬ÐÐÐ¯ ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ ÐŸÐžÐ Ð¢Ð 80..."
          # ÐžÑÐ²Ð¾Ð±Ð¾Ð¶Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ñ€Ñ‚ 80 Ð”Ðž Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¿Ð¾Ñ€Ñ‚ 80..."
          sudo netstat -tlnp | grep :80 || echo "ÐŸÐ¾Ñ€Ñ‚ 80 ÑÐ²Ð¾Ð±Ð¾Ð´ÐµÐ½"
          
          echo "ÐžÑÐ²Ð¾Ð±Ð¾Ð¶Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ñ€Ñ‚ 80..."
          sudo systemctl stop nginx 2>/dev/null || echo "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ nginx Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
          sudo systemctl disable nginx 2>/dev/null || echo "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ nginx ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½"
          sudo fuser -k 80/tcp 2>/dev/null || echo "ÐÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 80"
          sudo pkill nginx 2>/dev/null || echo "ÐÐµÑ‚ nginx Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²"
          sudo pkill apache2 2>/dev/null || echo "ÐÐµÑ‚ apache Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²"
          
          # Ð–Ð´Ñ‘Ð¼ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ð¾Ñ€Ñ‚Ð°
          sleep 3
          
          # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð°
          if sudo netstat -tlnp | grep :80; then
            echo "âš ï¸ ÐŸÐ¾Ñ€Ñ‚ 80 Ð²ÑÑ‘ ÐµÑ‰Ñ‘ Ð·Ð°Ð½ÑÑ‚:"
            sudo netstat -tlnp | grep :80
            echo "ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼ Ð²ÑÐµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 80..."
            sudo lsof -ti:80 | xargs sudo kill -9 2>/dev/null || echo "ÐÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ"
            sleep 2
          else
            echo "âœ… ÐŸÐ¾Ñ€Ñ‚ 80 Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´Ñ‘Ð½"
          fi
          
          echo "Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
          sudo docker compose -f infra/docker-compose.yml up -d --build
          
          echo "ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
          sleep 30
          
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
          if ! sudo docker compose -f infra/docker-compose.yml ps | grep "foodgram-nginx" | grep -q "Up"; then
            echo "âš ï¸  Nginx Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½. Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñƒ Ñ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð¼ 80..."
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¿Ð¾Ñ€Ñ‚ 80
            echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð¿Ð¾Ñ€Ñ‚ 80..."
            sudo netstat -tlnp | grep :80 || echo "ÐÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 80"
            
            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ nginx ÐµÑÐ»Ð¸ Ð¾Ð½ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½
            echo "ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ nginx..."
            sudo systemctl stop nginx 2>/dev/null || echo "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ nginx Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
            sudo systemctl disable nginx 2>/dev/null || echo "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ nginx ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½"
            
            # Ð£Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 80
            echo "ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ñ€Ñ‚ 80..."
            sudo fuser -k 80/tcp 2>/dev/null || echo "ÐÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð² Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 80"
            sudo pkill nginx 2>/dev/null || echo "ÐÐµÑ‚ nginx Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²"
            
            # Ð–Ð´Ñ‘Ð¼ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ð¾Ñ€Ñ‚Ð°
            sleep 5
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ñ€Ñ‚Ð°
            if sudo netstat -tlnp | grep :80; then
              echo "ÐŸÐ¾Ñ€Ñ‚ 80 Ð²ÑÑ‘ ÐµÑ‰Ñ‘ Ð·Ð°Ð½ÑÑ‚. ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼ Ð²ÑÐµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹..."
              sudo pkill apache2 2>/dev/null || echo "ÐÐµÑ‚ apache Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²"
              sleep 3
            fi
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ nginx ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
            echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ nginx ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€..."
            sudo docker compose -f infra/docker-compose.yml up -d nginx
            
            sleep 10
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
            if sudo docker compose -f infra/docker-compose.yml ps | grep nginx | grep -q "Up"; then
              echo "âœ… Nginx ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
            else
              echo "âŒ Nginx Ð²ÑÑ‘ ÐµÑ‰Ñ‘ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½. ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð¸:"
              sudo docker compose -f infra/docker-compose.yml logs nginx
            fi
          else
            echo "âœ… Nginx ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
          fi
          
          sudo docker compose -f infra/docker-compose.yml ps
          
          echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð°: http://${{ env.PROD_HOST }}"
          
          echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° MinIO..."
          sleep 10  # Ð”Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼Ñ MinIO Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒÑÑ
          
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ MinIO Client
          echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° MinIO Client..."
          curl -s https://dl.min.io/client/mc/release/linux-amd64/mc -o /tmp/mc
          chmod +x /tmp/mc
          
          # ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ MinIO
          echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ MinIO..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -s http://localhost:9000/minio/health/live > /dev/null 2>&1; then
              echo "âœ… MinIO Ð³Ð¾Ñ‚Ð¾Ð²"
              break
            fi
            echo "â³ MinIO ÐµÑ‰Ñ‘ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð², Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° $((attempt + 1))/$max_attempts..."
            sleep 10
            attempt=$((attempt + 1))
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ MinIO Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾ÑÐ»Ðµ $max_attempts Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº"
            sudo docker compose -f infra/docker-compose.yml logs minio
          else
            # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ MinIO
            echo "ðŸ”‘ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MinIO..."
            /tmp/mc alias set local http://localhost:9000 ${{ secrets.MINIO_ACCESS_KEY }} ${{ secrets.MINIO_SECRET_KEY }}
            
            # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ bucket
            echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ bucket 'foodgram'..."
            /tmp/mc mb local/foodgram --ignore-existing
            
            # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½ÑƒÑŽ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÑƒ Ð´Ð»Ñ Ð¼ÐµÐ´Ð¸Ð°
            echo "ðŸ”’ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ð¾Ð¹ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸..."
            /tmp/mc anonymous set public local/foodgram/media/
            
            # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ CORS
            echo "ðŸŒ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° CORS..."
            cat > /tmp/cors.json << 'EOF'
            {
              "CORSRules": [
                {
                  "AllowedOrigins": ["*"],
                  "AllowedMethods": ["GET", "HEAD"],
                  "AllowedHeaders": ["*"],
                  "MaxAgeSeconds": 3600
                }
              ]
            }
            EOF
            
            /tmp/mc cors set /tmp/cors.json local/foodgram
            
            echo "âœ… MinIO Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
            echo "ðŸ“Š Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ bucket:"
            /tmp/mc ls local/foodgram --recursive | head -5 || echo "Bucket Ð¿ÑƒÑÑ‚"
            
            # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
            rm -f /tmp/mc /tmp/cors.json
          fi
          
          echo "=== Ð”Ð•ÐŸÐ›ÐžÐ™ Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð Ð£Ð¡ÐŸÐ•Ð¨ÐÐž ==="