name: Deploy Foodgram to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROD_HOST: 89.169.174.76
  DOMAIN: foodgram.freedynamicdns.net

jobs:
  tests:
    name: Run tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements/development.txt
        
    - name: Run tests
      run: |
        cd backend
        python -m pytest --tb=short -v
        
    - name: Check code style
      run: |
        cd backend
        flake8 .

  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest
    needs: tests
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        password: ${{ secrets.PROD_PASSWORD }}
        debug: true
        script: |
          set -e
          
          echo "=== НАЧАЛО ДЕПЛОЯ ==="
          echo "Пользователь: $(whoami)"
          echo "Домашняя директория: $HOME"
          echo "Текущая директория: $(pwd)"
          
          echo "Переход в рабочую директорию..."
          mkdir -p $HOME/foodgram
          cd $HOME/foodgram
          
          echo "Обновление кода..."
          if [ -d ".git" ]; then
            echo "Обновляем существующий репозиторий..."
            git fetch origin
            git reset --hard origin/main
          else
            echo "Клонируем репозиторий..."
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          echo "Создание .env файла..."
          mkdir -p infra
          cat > infra/.env << EOF
          # Django settings
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DJANGO_SETTINGS_MODULE=foodgram.settings.production
          ALLOWED_HOSTS=${{ env.DOMAIN }},${{ env.PROD_HOST }},localhost,127.0.0.1
          
          # Database
          POSTGRES_DB=foodgram
          POSTGRES_USER=foodgram_user
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          
          # Redis
          REDIS_HOST=redis
          REDIS_PORT=6379
          
          # MinIO
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          MINIO_BUCKET_NAME=foodgram
          MINIO_USE_HTTPS=False
          MINIO_HOST=minio
          
          # Email
          EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
          DEFAULT_FROM_EMAIL=noreply@${{ env.DOMAIN }}
          
          # Domain
          DOMAIN_NAME=${{ env.DOMAIN }}
          EOF
          
          echo "Проверка Docker..."
          docker --version || echo "Docker не установлен"
          docker-compose --version || echo "Docker Compose не установлен"
          
          echo "Остановка старых контейнеров..."
          docker-compose -f infra/docker-compose.yml down --remove-orphans || echo "Нет запущенных контейнеров"
          
          echo "Сборка и запуск контейнеров..."
          docker-compose -f infra/docker-compose.yml up -d --build
          
          echo "Ожидание запуска сервисов..."
          sleep 30
          
          echo "Проверка состояния контейнеров..."
          docker-compose -f infra/docker-compose.yml ps
          
          echo "🎉 Деплой завершен!"
          echo "🌐 Сайт должен быть доступен на: http://${{ env.PROD_HOST }}" 