name: Deploy Foodgram to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROD_HOST: 89.169.174.76
  DOMAIN: foodgram.freedynamicdns.net

jobs:
  tests:
    name: Run tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements/development.txt
        
    - name: Run tests
      run: |
        cd backend
        python -m pytest --tb=short -v
        
    - name: Check code style
      run: |
        cd backend
        flake8 .

  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest
    needs: tests
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          set -e
          
          echo "ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ..."
          cd /home/foodgram/app || {
            echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸..."
            mkdir -p /home/foodgram/app
            cd /home/foodgram/app
          }
          
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²..."
          if [ ! -f "/etc/letsencrypt/live/${{ env.DOMAIN }}/fullchain.pem" ]; then
            echo "âš ï¸  SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ setup_ssl_certbot.sh"
            echo "Ð”Ð»Ñ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:"
            echo "bash scripts/deploy/setup_ssl_certbot.sh"
            exit 1
          fi
          
          echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð°..."
          if [ -d ".git" ]; then
            git fetch origin
            git reset --hard origin/main
          else
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
          cat > infra/.env << EOF
          # Django settings
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DJANGO_SETTINGS_MODULE=foodgram.settings.production
          ALLOWED_HOSTS=${{ env.DOMAIN }},${{ env.PROD_HOST }},localhost,127.0.0.1
          
          # Database
          POSTGRES_DB=foodgram
          POSTGRES_USER=foodgram_user
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          
          # Redis
          REDIS_HOST=redis
          REDIS_PORT=6379
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # MinIO
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          MINIO_BUCKET_NAME=foodgram
          MINIO_USE_HTTPS=False
          MINIO_HOST=minio
          
          # Email
          EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
          DEFAULT_FROM_EMAIL=noreply@${{ env.DOMAIN }}
          
          # Security Ð´Ð»Ñ HTTPS
          SECURE_SSL_REDIRECT=True
          SESSION_COOKIE_SECURE=True
          CSRF_COOKIE_SECURE=True
          
          # Domain
          DOMAIN_NAME=${{ env.DOMAIN }}
          EOF
          
          echo "ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
          docker-compose -f infra/docker-compose.yml down --remove-orphans || true
          
          echo "ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²..."
          docker system prune -f || true
          
          echo "Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Ð½Ð¾Ð²Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
          docker-compose -f infra/docker-compose.yml up -d --build
          
          echo "ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
          sleep 60
          
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
          docker-compose -f infra/docker-compose.yml ps
          
          echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°..."
          docker-compose -f infra/docker-compose.yml exec -T backend python manage.py shell -c "
          from django.contrib.auth import get_user_model
          User = get_user_model()
          if not User.objects.filter(email='admin@${{ env.DOMAIN }}').exists():
              User.objects.create_superuser(
                  email='admin@${{ env.DOMAIN }}',
                  password='${{ secrets.ADMIN_PASSWORD }}',
                  username='admin',
                  first_name='Admin',
                  last_name='User'
              )
              print('Superuser created')
          else:
              print('Superuser already exists')
          " || true
          
          echo "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¸Ð½Ð³Ñ€ÐµÐ´Ð¸ÐµÐ½Ñ‚Ð¾Ð²..."
          docker-compose -f infra/docker-compose.yml exec -T backend python manage.py load_ingredients || true
          
          echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          docker-compose -f infra/docker-compose.yml exec -T backend python manage.py create_test_data || true
          
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸..."
          sleep 10
          curl -f http://localhost/api/ || echo "API Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð½ÑƒÑ‚"
          
          echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚: https://${{ env.DOMAIN }}"
          echo "ðŸ”§ ÐÐ´Ð¼Ð¸Ð½ÐºÐ°: https://${{ env.DOMAIN }}/admin/"
          echo "ðŸ“¡ API: https://${{ env.DOMAIN }}/api/" 