name: Deploy Foodgram to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROD_HOST: 89.169.174.76
  DOMAIN: foodgram.freedynamicdns.net

jobs:
  tests:
    name: Run tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements/development.txt
        
    - name: Run tests
      run: |
        cd backend
        python -m pytest --tb=short -v
        
    - name: Check code style
      run: |
        cd backend
        flake8 .

  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest
    needs: tests
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        password: ${{ secrets.PROD_PASSWORD }}
        debug: true
        script: |
          set -e
          
          echo "=== ÐÐÐ§ÐÐ›Ðž Ð”Ð•ÐŸÐ›ÐžÐ¯ ==="
          echo "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $(whoami)"
          echo "Ð”Ð¾Ð¼Ð°ÑˆÐ½ÑÑ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $HOME"
          echo "Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $(pwd)"
          
          echo "ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ..."
          mkdir -p $HOME/foodgram
          cd $HOME/foodgram
          
          echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð°..."
          if [ -d ".git" ]; then
            echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
            git fetch origin
            git reset --hard origin/main
          else
            echo "ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹..."
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
          mkdir -p infra
          cat > infra/.env << EOF
          # Django settings
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DJANGO_SETTINGS_MODULE=foodgram.settings.production
          ALLOWED_HOSTS=${{ env.DOMAIN }},${{ env.PROD_HOST }},localhost,127.0.0.1
          
          # Database
          POSTGRES_DB=foodgram
          POSTGRES_USER=foodgram_user
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          
          # Redis
          REDIS_HOST=redis
          REDIS_PORT=6379
          
          # MinIO
          MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          MINIO_BUCKET_NAME=foodgram
          MINIO_USE_HTTPS=False
          MINIO_HOST=minio
          
          # Email
          EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
          DEFAULT_FROM_EMAIL=noreply@${{ env.DOMAIN }}
          
          # Domain
          DOMAIN_NAME=${{ env.DOMAIN }}
          EOF
          
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker..."
          docker --version || echo "Docker Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
          docker-compose --version || echo "Docker Compose Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
          
          echo "ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
          docker-compose -f infra/docker-compose.yml down --remove-orphans || echo "ÐÐµÑ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²"
          
          echo "Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
          docker-compose -f infra/docker-compose.yml up -d --build
          
          echo "ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
          sleep 30
          
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
          docker-compose -f infra/docker-compose.yml ps
          
          echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð°: http://${{ env.PROD_HOST }}" 