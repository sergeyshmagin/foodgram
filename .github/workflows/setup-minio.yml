name: Setup MinIO

on:
  workflow_dispatch:
    inputs:
      reason:
        description: '–ü—Ä–∏—á–∏–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MinIO'
        required: false
        default: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ MinIO –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'

env:
  PROD_HOST: "89.169.174.76"
  DOMAIN: "foodgram.freedynamicdns.net"

jobs:
  setup-minio:
    name: Setup MinIO on production
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup MinIO
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        debug: true
        script: |
          set -e
          
          echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MinIO –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π..."
          echo "–ü—Ä–∏—á–∏–Ω–∞: ${{ github.event.inputs.reason }}"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd $HOME/foodgram
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
          echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
          sudo docker compose -f infra/docker-compose.yml ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ MinIO —Ä–∞–±–æ—Ç–∞–µ—Ç
          if ! sudo docker compose -f infra/docker-compose.yml ps | grep minio | grep -q "Up"; then
            echo "‚ùå MinIO –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            sudo docker compose -f infra/docker-compose.yml up -d minio
            sleep 15
          fi
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º MinIO —á–µ—Ä–µ–∑ Docker exec
          echo "üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MinIO..."
          
          sudo docker compose -f infra/docker-compose.yml exec -T minio sh -c '
            # –ñ–¥—ë–º –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ MinIO
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ MinIO..."
            attempt=0
            max_attempts=30
            while [ $attempt -lt $max_attempts ]; do
              if curl -f http://localhost:9000/minio/health/live > /dev/null 2>&1; then
                echo "‚úÖ MinIO –≥–æ—Ç–æ–≤"
                break
              fi
              echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $((attempt + 1))/$max_attempts..."
              sleep 2
              attempt=$((attempt + 1))
            done
            
            if [ $attempt -eq $max_attempts ]; then
              echo "‚ùå MinIO –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
              exit 1
            fi
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º alias (credentials –±–µ—Ä—ë–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
            echo "üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
            mc alias set local http://localhost:9000 $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD
            
            # –°–æ–∑–¥–∞—ë–º bucket –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç  
            echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ bucket..."
            mc mb local/foodgram --ignore-existing || echo "Bucket —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            
            # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É media
            echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ media..."
            mc mb local/foodgram/media --ignore-existing || echo "–ü–∞–ø–∫–∞ media —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É–±–ª–∏—á–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è media
            echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–±–ª–∏—á–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏..."
            mc anonymous set public local/foodgram/media/
            
            echo "üìä –°—Ç–∞—Ç—É—Å bucket:"
            mc ls local/foodgram/ || echo "Bucket –ø—É—Å—Ç"
            
            echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫–∏:"
            mc anonymous get local/foodgram/media/ || echo "–ü–æ–ª–∏—Ç–∏–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
            
            echo "‚úÖ MinIO –Ω–∞—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          '
          
          echo "üåê –¢–µ–ø–µ—Ä—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç–µ"
          echo "üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: https://${{ env.DOMAIN }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç media
          echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ media —Ñ–∞–π–ª–æ–≤..."
          response=$(curl -I "https://${{ env.DOMAIN }}/media/" 2>/dev/null | head -1 || echo "–¢–µ—Å—Ç –Ω–µ —É–¥–∞–ª—Å—è")
          echo "–û—Ç–≤–µ—Ç nginx: $response"
          
          echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MinIO –∑–∞–≤–µ—Ä—à–µ–Ω–∞!" 