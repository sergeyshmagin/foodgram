name: Load Data to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to confirm production data loading'
        required: true
        default: 'no'
      load_type:
        description: 'Type of data to load'
        required: true
        default: 'basic'
        type: choice
        options:
        - basic
        - demo
        - full

env:
  PROD_HOST: 89.169.174.76

jobs:
  load-production-data:
    name: Load data to production
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'
    
    steps:
    - name: Load production data
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          set -e
          echo "=== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –í –ü–†–û–î–ê–ö–®–ù ==="
          
          cd $HOME/foodgram
          
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          sudo docker compose -f infra/docker-compose.yml ps
          
          if [ "${{ github.event.inputs.load_type }}" = "basic" ] || [ "${{ github.event.inputs.load_type }}" = "full" ]; then
            echo "üîß –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏ —Ç–µ–≥–∏)..."
            sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py setup_production
            
            echo "ü•ï –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –∏–∑ CSV..."
            sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py load_ingredients --file data/ingredients.csv
          fi
          
          if [ "${{ github.event.inputs.load_type }}" = "demo" ] || [ "${{ github.event.inputs.load_type }}" = "full" ]; then
            echo "üçΩÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ (—Ä–µ—Ü–µ–ø—Ç—ã)..."
            if sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py load_demo_data 2>/dev/null; then
              echo "‚úÖ –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
            else
              echo "‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ load_demo_data –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            fi
          fi
          
          echo ""
          echo "‚úÖ –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ó–ê–í–ï–†–®–ï–ù–ê!"
          echo ""
          echo "üìã –ê–ö–ö–ê–£–ù–¢–´ –î–õ–Ø –í–•–û–î–ê:"
          echo "üë§ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: admin@foodgram.local / admin123"
          echo ""
          echo "üåê Admin –ø–∞–Ω–µ–ª—å: https://foodgram.freedynamicdns.net/admin/"
          echo "üåê –°–∞–π—Ç: https://foodgram.freedynamicdns.net/" 