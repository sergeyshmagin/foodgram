name: Setup Test Data

on:
  workflow_dispatch:

env:
  PROD_HOST: 89.169.174.76

jobs:
  setup-test-data:
    name: Load test data to production
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup test data on production server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        debug: true
        script: |
          set -e
          
          echo "üöÄ –ó–ê–ì–†–£–ó–ö–ê –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–• FOODGRAM"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd ~/foodgram
          
          echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤..."
          sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py load_ingredients || echo "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
          
          echo "üë§ –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
          sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py setup_foodgram
          
          echo "üç≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
          sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py load_demo_data
          
          echo "üèóÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MinIO..."
          sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py setup_minio || echo "MinIO —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
          sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py shell -c "
          from django.contrib.auth import get_user_model
          from apps.recipes.models import Recipe, Tag, Ingredient
          User = get_user_model()
          print(f'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {User.objects.count()}')
          print(f'üç≥ –†–µ—Ü–µ–ø—Ç—ã: {Recipe.objects.count()}')
          print(f'üè∑Ô∏è –¢–µ–≥–∏: {Tag.objects.count()}')
          print(f'ü•ï –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã: {Ingredient.objects.count()}')
          "
          
          echo ""
          echo "‚úÖ –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï –ó–ê–ì–†–£–ñ–ï–ù–´!"
          echo ""
          echo "üîë –£–ß–ï–¢–ù–´–ï –î–ê–ù–ù–´–ï:"
          echo "üë®‚Äçüíª –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: admin@foodgram.ru / admin123"
          echo "üë§ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: test@foodgram.ru / testpass123"
          echo ""
          echo "üåê –°–∞–π—Ç: https://foodgram.freedynamicdns.net"
          echo "üîß –ê–¥–º–∏–Ω–∫–∞: https://foodgram.freedynamicdns.net/admin/" 