name: Setup Test Data

on:
  workflow_dispatch:

env:
  PROD_HOST: 89.169.174.76

jobs:
  setup-test-data:
    name: Load test data to production
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup test data on production server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        debug: true
        script: |
          set -e
          
          echo "ğŸš€ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ¢Ğ•Ğ¡Ğ¢ĞĞ’Ğ«Ğ¥ Ğ”ĞĞĞĞ«Ğ¥ FOODGRAM"
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‡ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
          cd ~/foodgram
          
          echo "ğŸ“¦ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²..."
          sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py load_ingredients || echo "Ğ˜Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ñ‹ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹"
          
          echo "ğŸ‘¤ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ¸ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…..."
          sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py setup_foodgram
          
          echo "ğŸ—ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° MinIO..."
          sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py setup_minio || echo "MinIO ÑƒĞ¶Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½"
          
          echo "ğŸ“Š ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°..."
          sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py shell -c "
          from django.contrib.auth import get_user_model
          from apps.recipes.models import Recipe, Tag, Ingredient
          User = get_user_model()
          print(f'ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸: {User.objects.count()}')
          print(f'ğŸ³ Ğ ĞµÑ†ĞµĞ¿Ñ‚Ñ‹: {Recipe.objects.count()}')
          print(f'ğŸ·ï¸ Ğ¢ĞµĞ³Ğ¸: {Tag.objects.count()}')
          print(f'ğŸ¥• Ğ˜Ğ½Ğ³Ñ€ĞµĞ´Ğ¸ĞµĞ½Ñ‚Ñ‹: {Ingredient.objects.count()}')
          "
          
          echo ""
          echo "âœ… Ğ¢Ğ•Ğ¡Ğ¢ĞĞ’Ğ«Ğ• Ğ”ĞĞĞĞ«Ğ• Ğ—ĞĞ“Ğ Ğ£Ğ–Ğ•ĞĞ«!"
          echo ""
          echo "ğŸ”‘ Ğ£Ğ§Ğ•Ğ¢ĞĞ«Ğ• Ğ”ĞĞĞĞ«Ğ•:"
          echo "ğŸ‘¨â€ğŸ’» ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€: admin@foodgram.ru / admin123"
          echo "ğŸ‘¤ Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: test@foodgram.ru / testpass123"
          echo ""
          echo "ğŸŒ Ğ¡Ğ°Ğ¹Ñ‚: https://foodgram.freedynamicdns.net"
          echo "ğŸ”§ ĞĞ´Ğ¼Ğ¸Ğ½ĞºĞ°: https://foodgram.freedynamicdns.net/admin/" 