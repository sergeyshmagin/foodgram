name: Fix Nginx Port 80 Issue

on:
  workflow_dispatch:

env:
  PROD_HOST: 89.169.174.76

jobs:
  fix-nginx:
    name: Fix nginx container
    runs-on: ubuntu-latest
    
    steps:
    - name: Fix nginx port 80 issue
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ env.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        debug: true
        script: |
          set -e
          
          echo "üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° NGINX"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd $HOME/foodgram
          
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç 80..."
          sudo netstat -tlnp | grep :80 || echo "–ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 80"
          sudo lsof -i :80 || echo "–ü–æ—Ä—Ç 80 —Å–≤–æ–±–æ–¥–µ–Ω"
          
          echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π nginx..."
          sudo systemctl stop nginx 2>/dev/null || echo "–°–∏—Å—Ç–µ–º–Ω—ã–π nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω"
          sudo systemctl disable nginx 2>/dev/null || echo "–°–∏—Å—Ç–µ–º–Ω—ã–π nginx —É–∂–µ –æ—Ç–∫–ª—é—á–µ–Ω"
          
          echo "–£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 80..."
          sudo fuser -k 80/tcp 2>/dev/null || echo "–ü–æ—Ä—Ç 80 —É–∂–µ —Å–≤–æ–±–æ–¥–µ–Ω"
          
          sleep 5
          
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞..."
          if sudo netstat -tlnp | grep :80; then
            echo "‚ùå –ü–æ—Ä—Ç 80 –≤—Å—ë –µ—â—ë –∑–∞–Ω—è—Ç:"
            sudo netstat -tlnp | grep :80
            echo "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã..."
            sudo pkill nginx 2>/dev/null || echo "Nginx –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            sudo pkill apache2 2>/dev/null || echo "Apache –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            sleep 3
          fi
          
          echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
          sudo docker compose -f infra/docker-compose.yml restart nginx || \
          sudo docker compose -f infra/docker-compose.yml up -d nginx
          
          sleep 10
          
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
          sudo docker compose -f infra/docker-compose.yml ps
          
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ nginx..."
          sudo docker compose -f infra/docker-compose.yml logs --tail=20 nginx
          
          echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å..."
          curl -s -o /dev/null -w "HTTP –∫–æ–¥: %{http_code}\n" http://localhost/ || echo "–°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          
          echo "‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
          echo "üåê –°–∞–π—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: http://${{ env.PROD_HOST }}" 