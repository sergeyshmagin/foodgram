name: Fix MinIO Images Display

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'fix'
        type: choice
        options:
          - fix
          - check
          - restart

jobs:
  fix-minio-images:
    runs-on: ubuntu-latest
    name: Fix MinIO Images Display
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute Fix MinIO Images Script
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e
            
            echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /home/yc-user/foodgram
            
            # –í—ã–±–∏—Ä–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
            case "${{ github.event.inputs.action }}" in
              "fix")
                echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MinIO..."
                
                # –°–∫–∞—á–∏–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                curl -s https://raw.githubusercontent.com/sergeyshmagin/foodgram/main/scripts/deploy/fix_minio_images.sh | bash
                ;;
                
              "check")
                echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ MinIO..."
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
                sudo docker compose -f infra/docker-compose.yml ps
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MinIO
                sudo docker compose -f infra/docker-compose.yml exec -T minio mc ls minio/ || true
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å MinIO API
                curl -I http://89.169.174.76:9000/minio/health/live || echo "‚ö†Ô∏è MinIO API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Django
                sudo docker compose -f infra/docker-compose.yml exec -T backend python manage.py shell -c "
                from django.conf import settings
                print('MEDIA_URL:', settings.MEDIA_URL)
                print('AWS_S3_ENDPOINT_URL:', settings.AWS_S3_ENDPOINT_URL)
                print('AWS_S3_CUSTOM_DOMAIN:', getattr(settings, 'AWS_S3_CUSTOM_DOMAIN', 'Not set'))
                "
                ;;
                
              "restart")
                echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
                
                # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º MinIO –∏ backend
                sudo docker compose -f infra/docker-compose.yml restart minio backend
                
                # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
                sleep 10
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
                sudo docker compose -f infra/docker-compose.yml ps
                ;;
            esac
            
            echo "‚úÖ –î–µ–π—Å—Ç–≤–∏–µ '${{ github.event.inputs.action }}' –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!" 